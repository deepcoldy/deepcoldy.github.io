---
date: 2017-05-16 18:47
status: public
title: 使用Webhook+nodejs将Git项目代码自动部署服务器
---

## 前言

公司前段时间加入了webpack+vue，由于忙于写业务，始终没有投入全部精力去优化项目。话虽这么说，但还是一边开发一边在优化开发体验的。
不讲别的，先讲讲标题说的是什么吧。
如果你也苦于每天在不断地在本机与服务器之间git push & git pull，如果你用的开发机build速度过于缓慢，那么我觉得有必要研究一下自动化服务器部署了。当然我讨论的离perfect还很远，只满足了单一项目的需要。

## 正篇
### Webhook
先确认你使用的git托管服务支持Webhook，并且自身有使用权限，我这边使用的是公司搭建的GitLab
![](https://ws2.sinaimg.cn/large/006tKfTcly1ffvgfq29i4j30v00pmn0f.jpg)

确认你有使用权限之后，我们就要开始搭建接收git请求的服务端了。我这边使用的当然是Node，你也可以选择用别的后端语言。
### 编写Node服务
我图方便，使用了[node-gitlab-webhook](https://www.npmjs.com/package/node-gitlab-webhook)该npm包，先引入。
```js
var http = require('http')
var createHandler = require('node-gitlab-webhook')
```

让node可以调用命令行的spawn。

```js
var spawn = require('child_process').spawn
```

接下来就是起服务了。这边我监听的是7777端口。

```js
var handler = createHandler([ // multiple handlers
  { path: '/push', secret: 'deepcold' },
  { path: '/build', secret: 'deepcold' }
])

http.createServer(function (req, res) {
  handler(req, res, function (err) {
    res.statusCode = 404
    res.end('no such location test')
  })
}).listen(7777)

handler.on('error', function (err) {
  console.error('Error:', err.message)
})

const rumCommand = (cmd, args, callback) => {
    const child = spawn(cmd, args)
    let response = ''
    child.stdout.on('data', buffer => response += buffer.toString())
    child.stdout.on('end', () => callback(response))
}

handler.on('push', function (event) {
  console.log(
    'Received a push event for %s',
    event.payload.repository.name
  )
  switch(event.path) {
    case '/push':
      rumCommand('sh', ['./pull.sh'], txt => {
        console.log(txt)
        if(txt.indexOf('vue/src/') !== -1 || txt.indexOf('vue/entry/') !== -1 || txt.indexOf('vue/static/') !== -1){ //这里是判断我的vue项目文件是否变化，如果变化会重新运行npm run build命令
            console.log('will build')
            rumCommand('sh', ['./build.sh'], txt => { // npm run build命令，储存在build.sh中
                console.log(txt)
            })
        }
      })
      break
  }
})
```

### 部署服务器
Node脚本写好后，就是上服务器部署了。当然服务器得支持Node.js环境，下面我说一下我给Ubuntu 12.04部署Node.js环境的过程。通常情况下都可以使用这种方式安装，简单稳妥。
首先安装Npm。
`sudo apt-get  install  npm`
之后安装一个npm工具叫[n](https://github.com/tj/n)
`npm install -g n`
于是-g安装会生成一个全局变量n，我直接安装了node最新的版本(latest)，也可以有稳定版(stable)和长期支持版本(lts)可选。
`n latest`
运行完了看一下node和npm的版本，确认无误后就算安装完了。之后我们会用PM2在后台运行我们的Node脚本。
```bash
node -v
npm -v
```
接着要配置Nginx
这是最简单的部分，只需要把流量转向上面监听的7777端口就行了，如下：
```nginx
server {
    listen 7778;
    access_log  /data/log/nginx/web_hook.access.log;
    location / {
        proxy_pass      http://127.0.0.1:7777;
    }
}
```
### 执行node脚本
使用最常见的[PM2](https://github.com/Unitech/pm2)，安装和使用就不说了，直接到github看。
`pm2 start [filename].js --watch #此命令会检测文件变化自动重启服务`

### 最后
再去配置一下gitlab上的事件。
![](https://ws3.sinaimg.cn/large/006tKfTcly1fg4k6egpcuj30q703naa7.jpg)

## 小记
这种方式还有一些不完善的地方，但是已经可以凑合使用了，在服务器端运行节省了我开发机的资源和时间，同时也避免了多人开发时的本地node_moudel版本不一致带来的问题。之后我会再开一篇文章去完善一下这个项目。

### 参考文章
[使用 WebHook 来自动部署 NodeJS 项目！](https://segmentfault.com/a/1190000005644039)