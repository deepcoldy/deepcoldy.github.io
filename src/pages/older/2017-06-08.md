---
date: 2017-06-08 18:29:15
status: public
title: Vue 2.3 源码笔记
---

本文章只针对Vue2.3版本，后续源码和api都可能产生变化，阅读时请因地制宜。

##入口文件
Vue 2.3的入口文件叫做runtime-with-compiler.js (此文件名可能会随着版本变化)
![](https://ws3.sinaimg.cn/large/006tNc79ly1fgctem88ywj30f0071gm9.jpg)

###流程图
![](https://ws1.sinaimg.cn/large/006tNc79ly1fgctinftemj315k14qac9.jpg)

### 文件关联
`src/core/instance/init.js` 引入 `src/core/instance/inject.js`  引入 `src/core/observer/index.js`
observer的index.js
`src/core/instance/index.js` 和 `src/core/instance/init.js` 都引入了 `src/core/instance/state.js`。
state.js是给 data 对象添加 Observer 的。
`src/core/instance/init.js` 中调用了 state.js 的 initState 方法
```js
// src/core/instance/init.js
export function initState (vm: Component) {
  vm._watchers = []
  const opts = vm.$options
  if (opts.props) initProps(vm, opts.props)
  if (opts.methods) initMethods(vm, opts.methods)
  if (opts.data) {
    initData(vm)  // 给 data 对象添加 Observer 
  } else {
    observe(vm._data = {}, true /* asRootData */)
  }
  if (opts.computed) initComputed(vm, opts.computed)
  if (opts.watch) initWatch(vm, opts.watch)
}
```
最重要的就是initDate()的方法
```js
// src/core/instance/init.js
function initData (vm: Component) {
  let data = vm.$options.data
  data = vm._data = typeof data === 'function'
    ? getData(data, vm)
    : data || {}
  if (!isPlainObject(data)) {
    data = {}
    process.env.NODE_ENV !== 'production' && warn(
      'data functions should return an object:\n' +
      'https://vuejs.org/v2/guide/components.html#data-Must-Be-a-Function',
      vm
    )
  }
  // proxy data on instance
  const keys = Object.keys(data)
  const props = vm.$options.props
  let i = keys.length
  while (i--) {
    if (props && hasOwn(props, keys[i])) {
      process.env.NODE_ENV !== 'production' && warn(
        `The data property "${keys[i]}" is already declared as a prop. ` +
        `Use prop default value instead.`,
        vm
      )
    } else if (!isReserved(keys[i])) {
      proxy(vm, `_data`, keys[i])
    }
  }
  // observe data
  observe(data, true /* asRootData */)
}
```
proxy 方法主要通过 Object.defineProperty 的 getter 和 setter 方法实现了代理。

在 initData 方法的最后，我们调用了 observe(data, this) 方法来对 data 做监听。observe 方法的源码定义如下：

```js
/**
 * Attempt to create an observer instance for a value,
 * returns the new observer if successfully observed,
 * or the existing observer if the value already has one.
 */
export function observe (value: any, asRootData: ?boolean): Observer | void {
  if (!isObject(value)) {
    return
  }
  let ob: Observer | void
  if (hasOwn(value, '__ob__') && value.__ob__ instanceof Observer) {
    ob = value.__ob__
  } else if (
    observerState.shouldConvert &&
    !isServerRendering() &&
    (Array.isArray(value) || isPlainObject(value)) &&
    Object.isExtensible(value) &&
    !value._isVue
  ) {
    ob = new Observer(value)
  }
  if (asRootData && ob) {
    ob.vmCount++
  }
  return ob
}
```


###参考文献
[Vue.js 2.0源码解析之前端渲染篇](https://www.qcloud.com/community/article/914746001486266056)
