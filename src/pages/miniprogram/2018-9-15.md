---
date: 2018-09-15
status: public
title: Taro与小程序哪些你不得不注意的事
---

## 注：v0.0.73版本(v1.0发布之前的最后一个版本)

### 1. 生命周期

由于该版本的生命周期并没有考虑执行顺序，子组件的生命周期可能会优先于父组件执行，则会在某些应用场景下出现问题。


### 2. JSX中不能通过表达式来控制子组件重走生命周期
结合问题1一起看,如果`this.props.host`是父组件的第一个请求后才能获得。

获得后所有网络请求才有host参数。

那么在其之后才能执行子组件的生命周期。通常可以如下写：

```jsx
<View>
{
  this.props.host?
  <ComponentA></ComponentA> // 此子组件的生命周期可能在父组件之前，并且不受控
}
</View>

```

如上所述，解决方案如下： 在使用`componentDidUpdate`、`componentWillReceiveProps`等生命周期满足不了需求的情况下，只能使用轮询的方式监听host参数是否已经get。

```js 
// 子组件
componentDidMount() {
  const interval = setInterval(async () => {
    if (this.props.host) {
      clearInterval(interval);
      ... // 具体逻辑
    }
  },100)
}

```

### 3. css隔离

Taro此版本并不支持css Modules，所以只能通过自定义不会重复的className完成css scoped。
好在只用保证每个页面内的css名称不重复就行了，页面之间的不用过分考虑。

```js
// index.js
render() {
  return (
    <View className='index-css'>
      ...        
    </View>
  )
}
```

```css
// index.scss 注意命名不要重复
.index-css{
  ...
}
```

### 4. 与Webview的通信

Webview与Native沟通主要通过URL和微信官方提供的一个函数`onMessage`来实现。
这个函数不是webview中调用之后实时触发，这点很迷惑人。
以下贴以下Taro在触发webview分享时的代码
```js

shareUrl = "";
shareObjFromWeb = {};
onMessage = e => { // 分享时触发
  if (e.target.data.length)
    this.shareObjFromWeb = e.target.data[e.target.data.length - 1]; // 取最新的一条分享内容
};
onShareAppMessage(options) {
  options.webViewUrl === this.shareObjFromWeb.href
    ? (this.shareUrl = this.shareObjFromWeb.share_url)
    : (this.shareUrl = options.webViewUrl);

  return {
    title: this.shareObjFromWeb.title || '',
    path: `/pages/webview/index?url=${encodeURIComponent(
      this.shareUrl
    )}`
  };
}

```

### 5. 简单场景不要使用Redux

如果使用`eventCenter`记得要在小程序onUnload之类的生命周期里面解绑。
```js
Taro.eventCenter.on('goWebview', this.gotoWebview);
Taro.eventCenter.trigger('goWebview', url)
Taro.eventCenter.off('goWebview');
```

### 6. 第三方平台小程序注意ext的配置

在微信开发者工具中，开发时一定要填入`extAppid`该字段，否则无法成功调用api。
在上传到草稿箱时，需要删掉此字段，才能上传到第三方平台的草稿箱，否则将会上传到测试用的小程序后台，然后该后台是托管的，所以将永远看不到自己调教的体验版。

```json
// src/ext.json 注意要使用此路径Taro才能自动复制到dist/ext.json。小程序才能引用到。
{
  "extEnable": true,
  "extAppid": "", // extAppid即开发的时候，可以授权使用的小程序
  "directCommit": true,
  "ext": {
    ... // 特殊的配置，由后端写入
  },
  "networkTimeout": {
    "request": 10000,
    "downloadFile": 10000
  }
}
```

在微信开发者工具中点击上传，如提示"以下文件没有被打包上传：· ext.json"，则表示提交成功。
记得上传后恢复extAppid字段。