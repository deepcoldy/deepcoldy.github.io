---
date: 2018-10-03
status: public
title: Vue的依赖收集
---

写了很多注释，看注释就好

## 订阅者 Dep

订阅者Dep作用是用来存放Watcher观察者对象。
Dep.target即全局唯一的Watcher

```js
class Dep {
  static target: ?Watcher; // 静态

  constructor () {
    this.subs = []; // 存放Watcher对象
  }

  addSub (sub) {
    this.subs.push(sub); // 添加一个Watcher对象
  }

  depend () {
    if (Dep.target) {
      Dep.target.addDep(this)
    }
  }

  notify () {
    const subs = this.subs.slice()
    for (let i = 0, l = subs.length; i < l; i++) {
      subs[i].update() // 通知所有Watcher对象更新UI
    }
  }
}
```

## 观察者 Watcher

```js
class Watcher {
    constructor () {
        // Dep.target = this; // 在new一个Watcher对象时将该对象赋值给Dep.target，在get中会用到
        this.get()
    }
    get() {
      pushTarget(this) // Dep.target = this 即新Dep.target入栈targetStack
      try {
        value = this.getter.call(vm, vm) // 执行reactiveGetter
      } catch (e) { // 错误提示
      } finally {
        if (this.deep) { // 递归
          traverse(value)
        }
        popTarget() // Dep.target 出栈
        this.cleanupDeps() // 清除旧订阅，防止重复触发更新
      }
      return value
    }
    addDep (dep: Dep) {
      const id = dep.id
      if (!this.newDepIds.has(id)) {
        this.newDepIds.add(id)
        this.newDeps.push(dep)
        if (!this.depIds.has(id)) {
          dep.addSub(this) // 添加一个Watcher对象
        }
      }
    }
    update () { // 更新UI 
      if (this.lazy) {
        this.dirty = true
      } else if (this.sync) {
        this.run()
      } else {
        queueWatcher(this)
      }
    }
}

```

## 封装

```js
function defineReactive (obj, key, val) {
  const dep = new Dep();
  
  Object.defineProperty(obj, key, {
    enumerable: true,
    configurable: true,
    get: function reactiveGetter () {
      dep.depend() // 即dep.addSub(Dep.target) 将Dep.target（即当前的Watcher对象存入dep的subs中）
      return val;
    },
    set: function reactiveSetter (newVal) {
      if (newVal === value || (newVal !== newVal && value !== value)) {
        return
      }
      dep.notify(); // 在set的时候触发dep的notify来通知所有的Watcher对象更新视图
    }
  });
}

class Vue {
  constructor(options) {
    this._data = options.data;
    observer(this._data);
    new Watcher();// 新建一个Watcher对象，Dep.target会指向这个Watcher对象
    // 视图更新
  }
}
```


