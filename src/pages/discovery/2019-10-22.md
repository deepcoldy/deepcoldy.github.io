---
date: 2019-10-22
status: public
title: 前端项目在Docker中实现 Hot Reload
---

### 通常情况

```
version: '3
  services:
    dev:
      image: node:12
      volumes:
        - .:/usr/src/service
      working_dir: /usr/src/services
      command: npm run dev
      ports: 
        - 3000:3000
```

这样写会有一些问题，比如node_modules怎么安装。

node_modules如果只是安装在本机，那么是无法用此方式同步到Docker中的。

注意：选择`command: npm install && npm run dev`这种方式是不行的

可以使用`command: bash -c "npm install && npm run dev"`

但是这样会导致每次重启都重新安装依赖，非常低效。

### 解决方式

由于version 3取消了extends模式，导致我们不能很简洁的实现目标。

所以还是继续使用version 2。

这边使用了一个volume专门存放node_modules。


```
version: '2'

  server:
    image: node:12
    volumes:
      - nodemodules:/usr/src/service/node_modules
      - .:/usr/src/service
    working_dir: /usr/src/service
    ports:
      - '3000:3000'
  install: # 安装依赖
    command: yarn install
    extends:
      service: server
  dev: # 开发模式
    command: npm run start:dev
    extends:
      service: server

volumes:
  nodemodules:
    external: true
```

生成volume：`docker volume create nodemodules` 当然还可以新建一些其他的volume(比如开发node时生成一个dist之类的目录供实时编译)

安装依赖：`docker-compose -f docker-compose.builder.yml run --rm install`

运行：`docker-compose up dev` 

如此就能做到在Docker中Hot Reload了。但还不完美。

### 其他问题

#### 代码保存了却没刷新界面

开发时我们可能会遇到一个问题，代码保存了，但是docker中却没有自动刷新。

通常这是由于使用了webpack的HotModuleReplacementPlugin导致的。

他是基于时间做的判断是否需要更新。

但docker中如果忽略了时区的影响，会导致容器与宿主机的时间不一样，从而导致Hot Reload失效。

```
version: '2'

  server:
    ... # 省略
    environment: # 添加时区
      - TZ=Asia/Shanghai
    ... # 省略
```

#### 宿主机开多容器，容器之间如何做通信

这是一个比较大的话题，准备在下一篇中讨论。


### 总结

在Docker中开发前端应用多少会遇到一些水土不服，要解决这些问题还是要详细阅读官方文档，灵活运用。

我在搭建过程中也能感到，前端的基础设施与后端的割裂，解决方案少只能自己摸索。

当然相信会越来越好。
